<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link
         rel="shortcut icon"
         href="../asset/img/LogiFlow.ico"
         type="image/x-icon"
      />
      <link
         rel="icon"
         type="image/png"
         sizes="16x10"
         href="../asset/img/LogiFlow-mini.png"
      />
      <link
         rel="apple-touch-icon"
         sizes="180x180"
         href="../asset/img/LogiFlow.png"
      />
      <link rel="manifest" href="/site.webmanifest" />
      <title>LogiFlow</title>
      <link rel="stylesheet" href="../asset/style/flash.css" />
      <link rel="stylesheet" href="../asset/style/adminstyle.css" />
      <style>
         .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
         }
         .btn-delete:hover {
            background: #c0392b;
         }
      </style>
   </head>
   <body>
      <nav>
         <h2>Arsip Dashboard</h2>
         <div class="btn-group">
            <a href="./admin.html" class="btn-nav back">⬅ Back to admin</a>
         </div>
      </nav>
      <div class="container" id="lunasContainer"></div>
      <script src="../asset/js/db.js"></script>
      <script src="../asset/js/flash.js"></script>
      <script>
         // ================== STRUKTUR HARGA ==================
         const strukturHarga = {
            standardReject: ["9", "10-14", "15-55"],
            super: {
               100: ["20-24", "25-55"],
               130: ["15-19", "20-24", "25-29", "30-55"],
               200: ["25-29", "30-39", "40-49", "50-80"],
               260: ["25-29", "30-39", "40-80"],
            },
         };

         // helper cari kelompok diameter
         function cariKelompok(kategori, ukuran, diameter) {
            if (
               kategori.toLowerCase() === "standard" ||
               kategori.toLowerCase() === "reject"
            ) {
               kategori = "standardReject";
            } else {
               kategori = kategori.toLowerCase();
            }
            const listKelompok =
               strukturHarga[kategori]?.[ukuran] ||
               strukturHarga[kategori] ||
               [];
            for (const kelompok of listKelompok) {
               const [min, max] = kelompok.split("-").map(Number);
               if (max) {
                  if (diameter >= min && diameter <= max) return kelompok;
               } else {
                  if (diameter >= min) return kelompok;
               }
            }
            return null;
         }

         // ================== RENDER ==================
         async function renderDataLunas() {
            const dataLunas = (await Storage.get("kayu_lunas")) || [];
            const hargaRaw = await Storage.get("harga_per_kelompok");
            // disimpan dengan id:'all' → ambil index 0
            const hargaPerKelompok =
               hargaRaw && hargaRaw.length ? hargaRaw[0] : {};

            const container = document.getElementById("lunasContainer");
            container.innerHTML = "";

            if (!dataLunas.length) {
               container.innerHTML = "<p>Tidak ada transaksi lunas.</p>";
               return;
            }

            dataLunas.forEach((transaksi) => {
               const date = new Date(transaksi.waktu);
               let cardHTML = `
      <div class="card">
        <div class="wrapper-info">
          <h3>Buyer: ${transaksi.pemesan}</h3>
          <p>Date: ${date.toISOString().slice(0, 16).replace("T", " - ")}</p>
          <p>Sender: ${transaksi.oleh}</p>
        </div>`;

               // kelompokkan per kategori
               const kategoriMap = {};
               transaksi.data.forEach((d) => {
                  if (!kategoriMap[d.kategori]) kategoriMap[d.kategori] = [];
                  kategoriMap[d.kategori].push(d);
               });

               Object.keys(kategoriMap).forEach((kat) => {
                  let totalVol = 0,
                     totalJml = 0,
                     totalHarga = 0;

                  cardHTML += `
        <h5>Category: ${kat}</h5>
        <table>
          <thead>
            <tr>
              <th>Ukuran</th>
              <th>Diameter</th>
              <th>Volume m³</th>
              <th>Jumlah</th>
              <th>Harga/m³</th>
            </tr>
          </thead>
          <tbody>`;

                  kategoriMap[kat].forEach((row) => {
                     const kelompok = cariKelompok(
                        kat,
                        row.ukuran,
                        row.diameter
                     );
                     const hargaKey = `${kat.toLowerCase()}-${
                        row.ukuran
                     }-${kelompok}`;
                     const hargaM3 = hargaPerKelompok[hargaKey] || 0;

                     totalVol += row.volume;
                     totalJml += row.jumlah;
                     totalHarga += row.volume * hargaM3;

                     cardHTML += `
          <tr>
            <td>${row.ukuran}</td>
            <td>${row.diameter}</td>
            <td>${row.volume}</td>
            <td>${row.jumlah}</td>
            <td>Rp ${hargaM3.toLocaleString()}</td>
          </tr>`;
                  });

                  cardHTML += `
          </tbody>
        </table>
        <p class="total-line">
          <span><strong>Total Volume:</strong> ${totalVol} m³ </span>
          <span><strong>Total Jumlah:</strong> ${totalJml} </span>
          <span><strong>Total Harga:</strong> Rp ${totalHarga.toLocaleString()} </span>
        </p>`;
               });

               cardHTML += `
      <button class="btn-delete" onclick="hapusTransaksi(${transaksi.id})">Delete Transaction</button>
      </div>`;

               container.innerHTML += cardHTML;
            });
         }

         async function hapusTransaksi(id) {
            flashConfirm("Delete transaction record?").then(async (ok) => {
               if (!ok) {
                  flashAlert("info", "Delete canceled.");
                  return;
               }
               await Storage.deleteRecord("kayu_lunas", id);
               flashAlert("success", "Transaction was deleted!");
               renderDataLunas();
            });
         }

         document.addEventListener("DOMContentLoaded", renderDataLunas);
      </script>
   </body>
</html>
