<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>LogiFlow | Signup</title>
      <link rel="stylesheet" href="../asset/style/bootstrap-icons.css" />
      <link rel="stylesheet" href="../asset/style/flash.css" />
      <link rel="stylesheet" href="../asset/style/loginStyle.css" />
   </head>
   <body>
      <div class="login-container">
         <div class="login-card">
            <h2>Create New User</h2>
            <form id="signupForm">
               <div class="input-group">
                  <label for="username"
                     ><i class="bi bi-person-fill"></i
                  ></label>
                  <input
                     type="text"
                     id="username"
                     required
                     placeholder="Name new user"
                  />
               </div>
               <div class="input-group">
                  <label for="password"><i class="bi bi-lock-fill"></i></label>
                  <input
                     type="password"
                     id="password"
                     required
                     placeholder="Password new user"
                  />
               </div>
               <div class="roles">
                  <label for="role">Choose Role</label>
                  <select id="role" required>
                     <option value="administrasi">administrasi</option>
                     <option value="operasional">operasional</option>
                  </select>
               </div>
               <button type="submit" class="login-btn">Signup</button>
               <p class="back-link">
                  <a href="./admin.html">Back to Dashboard</a>
               </p>
            </form>
         </div>
      </div>

      <script src="../asset/js/db.js"></script>
      <script src="../asset/js/bootstrap.bundle.js"></script>
      <script src="../asset/js/flash.js"></script>
      <script>
         // ========= UTILS HASH (PBKDF2) =========
         const toHex = (buf) =>
            [...new Uint8Array(buf)]
               .map((b) => b.toString(16).padStart(2, "0"))
               .join("");
         async function hashPassword(
            password,
            {
               iterations = 100000,
               saltBytes = 16,
               hash = "SHA-256",
               keyLenBytes = 32,
            } = {}
         ) {
            const salt = new Uint8Array(saltBytes);
            crypto.getRandomValues(salt);
            const enc = new TextEncoder();
            const baseKey = await crypto.subtle.importKey(
               "raw",
               enc.encode(password),
               { name: "PBKDF2" },
               false,
               ["deriveBits"]
            );
            const bits = await crypto.subtle.deriveBits(
               { name: "PBKDF2", hash, salt, iterations },
               baseKey,
               keyLenBytes * 8
            );
            return {
               hash,
               iterations,
               salt: toHex(salt.buffer),
               derivedKey: toHex(bits),
            };
         }

         // ========= HELPERS USER =========
         async function getUser(username) {
            const users = await Storage.get("users_db");
            return users.find((u) => u.id === username) || null;
         }
         async function saveUser(username, data) {
            await Storage.set("users_db", { id: username, ...data });
         }

         // ========= CEK HAK AKSES (hanya admin boleh buka signup) =========
         (async () => {
            const logged = await Storage.get("loggedInUser");
            const currentUser = logged && logged.length ? logged[0] : null;
            if (!currentUser || currentUser.role !== "administrasi") {
               window.location.href = "./login.html";
            }
         })();

         // ========= SIGNUP =========
         document
            .getElementById("signupForm")
            .addEventListener("submit", async (e) => {
               e.preventDefault();

               const username = document
                  .getElementById("username")
                  .value.trim();
               const password = document
                  .getElementById("password")
                  .value.trim();
               const role = document.getElementById("role").value;

               if (!username || !password) {
                  flashAlert("error", "Username and Password empty");
                  return;
               }

               const existing = await getUser(username);
               if (existing) {
                  flashAlert("error", "Username already exists");
                  return;
               }

               const record = await hashPassword(password);
               await saveUser(username, { ...record, role });

               flashAlert("success", `User ${username} was created`);
               setTimeout(() => (window.location.href = "./admin.html"), 1500);
            });
      </script>
   </body>
</html>
